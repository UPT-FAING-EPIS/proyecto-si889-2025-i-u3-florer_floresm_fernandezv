name: üèóÔ∏è Terraform Plan & Cost Analysis

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Acci√≥n a realizar'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply
        - destroy

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.3

      - name: üöÄ Terraform Init
        working-directory: ./terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: terraform init

      - name: üìã Terraform Plan
        working-directory: ./terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: terraform plan -out=tfplan

      - name: üì§ Upload Terraform plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: ./terraform/tfplan

      - name: üí∞ Setup Infracost
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: üìä Run Infracost breakdown
        working-directory: ./terraform
        run: |
          infracost breakdown --path=. --format=json --out-file=/tmp/infracost.json
        env:
          INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}

      - name: üìã Generar reporte de costos (tabla)
        run: |
          infracost output --path=/tmp/infracost.json --format=table --out-file=/tmp/cost-table.txt

      - name: üåê Generar reporte de costos (HTML)
        run: |
          infracost output --path=/tmp/infracost.json --format=html --out-file=/tmp/cost-report.html

      - name: üìù Generar comentario para GitHub
        run: |
          infracost output --path=/tmp/infracost.json --format=github-comment --out-file=/tmp/github-comment.md

      - name: üì§ Subir artefactos de Infracost
        uses: actions/upload-artifact@v4
        with:
          name: infracost-reports
          path: |
            /tmp/cost-table.txt
            /tmp/cost-report.html
            /tmp/github-comment.md
            /tmp/infracost.json

      - name: üìä A√±adir resumen de costos
        run: |
          echo '## üí∞ An√°lisis de Costos de AWS' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '### üìã Resumen de costos estimados:' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat /tmp/cost-table.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '---' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '### üìÅ Reportes disponibles para descarga:' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '- üìã **Tabla de costos:** `cost-table.txt`' >> $GITHUB_STEP_SUMMARY
          echo '- üåê **Reporte HTML interactivo:** `cost-report.html`' >> $GITHUB_STEP_SUMMARY
          echo '- üìù **Comentario GitHub:** `github-comment.md`' >> $GITHUB_STEP_SUMMARY
          echo '- üìÑ **Datos JSON completos:** `infracost.json`' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '### üöÄ Pr√≥ximos pasos:' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '1. **Revisar los costos** estimados arriba' >> $GITHUB_STEP_SUMMARY
          echo '2. **Descargar los reportes** para an√°lisis detallado' >> $GITHUB_STEP_SUMMARY
          echo '3. **Ejecutar terraform apply** si los costos son aceptables' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '---' >> $GITHUB_STEP_SUMMARY
          echo '*Generado por Infracost - An√°lisis autom√°tico de costos de infraestructura*' >> $GITHUB_STEP_SUMMARY

      # Ejecutar terraform apply solo si se selecciona esa opci√≥n
      - name: ‚ö° Terraform Apply
        if: github.event.inputs.action == 'apply'
        working-directory: ./terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: terraform apply -auto-approve tfplan

      - name: üóëÔ∏è Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        working-directory: ./terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: terraform destroy -auto-approve
